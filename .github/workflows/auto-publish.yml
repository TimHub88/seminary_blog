name: Seminary Blog Auto-Publisher

on:
  schedule:
    # ExÃ©cution tous les 2 jours Ã  8h00 UTC (9h00 Paris Ã©tÃ©, 10h00 Paris hiver)
    - cron: '0 8 */2 * *'
  
  # Permettre l'exÃ©cution manuelle
  workflow_dispatch:
    inputs:
      force_generation:
        description: 'Forcer la gÃ©nÃ©ration mÃªme si rÃ©cent article existe'
        required: false
        default: 'false'
        type: boolean
      
      debug_mode:
        description: 'Mode debug avec logs dÃ©taillÃ©s'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    
    # ğŸ” Variables d'environnement avec secrets
    env:
      CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
      UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
      UNSPLASH_SECRET_KEY: ${{ secrets.UNSPLASH_SECRET_KEY }}
    
    # ğŸ” Permissions nÃ©cessaires pour le git push
    permissions:
      contents: write    # Pour lire/Ã©crire le code
      actions: read      # Pour lire les actions
      pages: write       # Pour GitHub Pages si activÃ©
      id-token: write    # Pour l'authentification
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # Token explicite
        fetch-depth: 0  # RÃ©cupÃ©rer tout l'historique pour Git
    
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” Run Diagnostic
      run: |
        echo "ğŸ” ExÃ©cution du diagnostic systÃ¨me..."
        python scripts/diagnostic.py
    
    - name: ğŸ” Check Recent Articles
      id: check_articles
      run: |
        # VÃ©rifier s'il y a eu un article dans les derniÃ¨res 40 heures
        # (buffer de 8h par rapport au cycle de 48h)
        CUTOFF_DATE=$(date -d '40 hours ago' '+%Y-%m-%d')
        RECENT_ARTICLES=$(find articles/ -name "*.html" -newer <(date -d "$CUTOFF_DATE" '+%Y%m%d%H%M.%S') 2>/dev/null | wc -l)
        
        echo "recent_articles=$RECENT_ARTICLES" >> $GITHUB_OUTPUT
        echo "cutoff_date=$CUTOFF_DATE" >> $GITHUB_OUTPUT
        
        if [ "$RECENT_ARTICLES" -gt 0 ] && [ "${{ github.event.inputs.force_generation }}" != "true" ]; then
          echo "skip_generation=true" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Article rÃ©cent trouvÃ© ($RECENT_ARTICLES), gÃ©nÃ©ration ignorÃ©e"
        else
          echo "skip_generation=false" >> $GITHUB_OUTPUT
          echo "âœ… GÃ©nÃ©ration autorisÃ©e"
        fi
    
    - name: ğŸ”§ Setup Environment
      if: steps.check_articles.outputs.skip_generation == 'false'
      run: |
        # CrÃ©er les rÃ©pertoires nÃ©cessaires
        mkdir -p articles data/image_cache images
        
        # VÃ©rifier les clÃ©s API
        if [ -z "$CHUTES_API_KEY" ]; then
          echo "âŒ CHUTES_API_KEY manquante"
          exit 1
        fi
        
        echo "âœ… Environment configurÃ©"
    
    - name: ğŸ“ Update Article Context
      if: steps.check_articles.outputs.skip_generation == 'false'
      run: |
        echo "ğŸ”„ Mise Ã  jour du contexte des articles..."
        python scripts/context_manager.py \
          --api-key "$CHUTES_API_KEY" \
          --show-context
    
    - name: ğŸ¤– Generate New Article
      if: steps.check_articles.outputs.skip_generation == 'false'
      id: generate_article
      run: |
        echo "ğŸš€ GÃ©nÃ©ration d'un nouvel article..."
        
        # Configurer les options selon le mode debug
        if [ "${{ github.event.inputs.debug_mode }}" == "true" ]; then
          export LOG_LEVEL=DEBUG
        fi
        
        # GÃ©nÃ©rer l'article avec gestion d'erreur
                if python scripts/article_generator.py \
          --chutes-api-key "$CHUTES_API_KEY" \
          --unsplash-access-key "$UNSPLASH_ACCESS_KEY" \
          --unsplash-secret-key "$UNSPLASH_SECRET_KEY" > generation.log 2>&1; then
          
          # RÃ©cupÃ©rer le nom du fichier gÃ©nÃ©rÃ©
          GENERATED_FILE=$(grep "Article sauvegardÃ©:" generation.log | tail -1 | sed 's/.*: //')
          echo "generated_file=$GENERATED_FILE" >> $GITHUB_OUTPUT
          echo "generation_success=true" >> $GITHUB_OUTPUT
          echo "âœ… Article gÃ©nÃ©rÃ©: $GENERATED_FILE"
          
        else
          echo "generation_success=false" >> $GITHUB_OUTPUT
          echo "âŒ Ã‰chec de gÃ©nÃ©ration"
          cat generation.log
          exit 1
        fi
    
    - name: ğŸ” Validate Generated Article
      if: steps.check_articles.outputs.skip_generation == 'false' && steps.generate_article.outputs.generation_success == 'true'
      run: |
        GENERATED_FILE="${{ steps.generate_article.outputs.generated_file }}"
        
        if [ -f "$GENERATED_FILE" ]; then
          echo "âœ… Fichier confirmÃ©: $GENERATED_FILE"
          
          # Validation SEO rapide
          python scripts/seo_validator.py "$GENERATED_FILE" --detailed > seo_report.txt
          
          # Afficher le rapport SEO
          echo "ğŸ“Š Rapport SEO:"
          head -10 seo_report.txt
          
          # VÃ©rifier la taille du fichier
          FILE_SIZE=$(stat -c%s "$GENERATED_FILE")
          if [ "$FILE_SIZE" -lt 5000 ]; then
            echo "âš ï¸ Fichier suspicieusement petit ($FILE_SIZE bytes)"
          fi
          
        else
          echo "âŒ Fichier gÃ©nÃ©rÃ© introuvable: $GENERATED_FILE"
          exit 1
        fi
    
    - name: ğŸ”§ Update Index Page
      if: steps.check_articles.outputs.skip_generation == 'false' && steps.generate_article.outputs.generation_success == 'true'
      run: |
        echo "ğŸ”„ Mise Ã  jour de la page d'accueil..."
        python scripts/update_index.py
    
    - name: ğŸ“Š Generate Statistics
      if: steps.check_articles.outputs.skip_generation == 'false' && steps.generate_article.outputs.generation_success == 'true'
      run: |
        echo "ğŸ“Š GÃ©nÃ©ration des statistiques..."
        
        TOTAL_ARTICLES=$(find articles/ -name "*.html" | wc -l)
        TOTAL_WORDS=$(find articles/ -name "*.html" -exec cat {} \; | wc -w)
        LAST_ARTICLE="${{ steps.generate_article.outputs.generated_file }}"
        
        echo "ğŸ“ˆ Statistiques du blog:"
        echo "  â€¢ Articles total: $TOTAL_ARTICLES"
        echo "  â€¢ Mots total: ~$TOTAL_WORDS"
        echo "  â€¢ Dernier article: $LAST_ARTICLE"
        echo "  â€¢ GÃ©nÃ©rÃ© le: $(date '+%Y-%m-%d %H:%M:%S UTC')"
    
    - name: ğŸ§¹ Cleanup Old Files
      if: steps.check_articles.outputs.skip_generation == 'false'
      run: |
        echo "ğŸ§¹ Nettoyage des anciens fichiers..."
        
        # Nettoyer les anciennes images (30+ jours)
        if [ -d "images" ]; then
          find images/ -name "*.jpg" -mtime +30 -delete 2>/dev/null || true
          CLEANED_IMAGES=$(find images/ -name "*.jpg" -mtime +30 | wc -l)
          echo "ğŸ—‘ï¸ Images nettoyÃ©es: $CLEANED_IMAGES"
        fi
        
        # Nettoyer les logs temporaires
        rm -f generation.log seo_report.txt 2>/dev/null || true
    
    - name: ğŸ”„ Commit and Push Changes
      if: steps.check_articles.outputs.skip_generation == 'false' && steps.generate_article.outputs.generation_success == 'true'
      run: |
        # Configuration Git avec authentification renforcÃ©e
        git config --global user.name 'Seminary Blog Bot'
        git config --global user.email 'blog-bot@goseminary.com'
        
        # VÃ©rifier les permissions git
        echo "ğŸ” VÃ©rification des permissions..."
        git remote -v
        
        # Synchroniser avec le repository distant avant modification
        echo "ğŸ”„ Synchronisation avec le repository distant..."
        git fetch origin
        git pull origin main --rebase || {
          echo "âš ï¸ Conflit dÃ©tectÃ©, rÃ©solution automatique..."
          git rebase --abort 2>/dev/null || true
          git pull origin main --no-rebase
        }
        
        # Ajouter les fichiers modifiÃ©s
        git add articles/ images/ data/ index.html
        
        # VÃ©rifier s'il y a des changements
        if git diff --staged --quiet; then
          echo "â„¹ï¸ Aucun changement Ã  commiter"
        else
          # Commit avec message informatif
          GENERATED_FILE="${{ steps.generate_article.outputs.generated_file }}"
          COMMIT_MSG="ğŸ¤– Auto-publish: $(basename "$GENERATED_FILE" .html)"
          
          echo "ğŸ’¾ Commit en cours..."
          git commit -m "$COMMIT_MSG"
          
          # Push avec retry et diagnostic
          echo "ğŸš€ Push vers origin/main..."
          
          # Tentative 1: Push normal
          if git push origin main; then
            echo "âœ… Push rÃ©ussi!"
          else
            echo "âš ï¸ Push Ã©chouÃ©, nouvelle synchronisation et retry..."
            
            # Afficher les informations de debug
            echo "ğŸ” Token prÃ©sent: $([[ -n "$GITHUB_TOKEN" ]] && echo "OUI" || echo "NON")"
            echo "ğŸ” Remote URL: $(git remote get-url origin)"
            echo "ğŸ” Branche actuelle: $(git branch --show-current)"
            echo "ğŸ” Statut git: $(git status --porcelain)"
            
            # Resynchroniser et retry
            git fetch origin
            git pull origin main --no-rebase || echo "âš ï¸ Pull Ã©chouÃ©, continuons..."
            
            # Tentative 2: Avec authentification explicite
            echo "ğŸ”„ Tentative avec authentification explicite..."
            if git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main; then
              echo "âœ… Push rÃ©ussi avec authentification explicite!"
            else
              echo "âŒ Push Ã©chouÃ© dÃ©finitivement"
              exit 1
            fi
          fi
          
          echo "âœ… Changements commitÃ©es et pushÃ©es"
          echo "ğŸ“„ Fichier: $GENERATED_FILE"
        fi
    
    - name: ğŸ“¢ Notify Success
      if: steps.check_articles.outputs.skip_generation == 'false' && steps.generate_article.outputs.generation_success == 'true'
      run: |
        echo "ğŸ‰ SUCCÃˆS: Nouvel article publiÃ©!"
        echo "ğŸ“„ Fichier: ${{ steps.generate_article.outputs.generated_file }}"
        echo "ğŸŒ Disponible sur: https://blog.goseminary.com"
        echo "ğŸ•’ Prochaine exÃ©cution prÃ©vue dans 48h"
    
    - name: ğŸ“¢ Notify Skip
      if: steps.check_articles.outputs.skip_generation == 'true'
      run: |
        echo "â„¹ï¸ GÃ©nÃ©ration ignorÃ©e: article rÃ©cent dÃ©tectÃ©"
        echo "ğŸ“… Articles rÃ©cents: ${{ steps.check_articles.outputs.recent_articles }}"
        echo "â­ï¸ Prochaine vÃ©rification dans 48h"
    
    - name: ğŸš¨ Handle Failure
      if: failure()
      run: |
        echo "âŒ Ã‰CHEC DU WORKFLOW"
        echo "ğŸ•’ Prochaine tentative dans 48h"
        
        # Afficher les logs en cas d'erreur
        if [ -f "generation.log" ]; then
          echo "ğŸ“‹ Logs de gÃ©nÃ©ration:"
          cat generation.log
        fi
        
        # CrÃ©er un rapport d'erreur simple
        echo "Erreur dÃ©tectÃ©e le $(date)" > error_report.txt
        echo "Workflow: ${{ github.workflow }}" >> error_report.txt
        echo "Run ID: ${{ github.run_id }}" >> error_report.txt 